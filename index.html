<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>打卡定位</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      font-family: sans-serif;
      background-color: #f0f0f0;
    }

    .content {
      width: 100%;
      text-align: center;
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    h1 {
      font-size: 5vw; /* 根據螢幕寬度縮放 */
      margin: 0 0 2vh;
    }

    button {
      font-size: 3vw;
      padding: 1vh 3vw;
      width: 50%;
      max-width: 300px;
      min-width: 150px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>打卡定位</h1>
  <button onclick="startCheckIn()">打卡</button>
  <script>
    const WHITELIST = ['U79020fb63e5c20703ee2cb9f34c0df02', 'Uyyyyyyyyyy']; // 你的 LINE 使用者 ID 清單
    const GAS_WEBHOOK = 'https://script.google.com/macros/s/AKfycby7ZdmGd61mSWBtn2yc4uxmD0NWMJoaDi3I4NyUZzpqsN9IPLB4AIZcS1iLxM0qWLFf/exec';
    const RENDER_WEBHOOK = 'https://line-location-bot.onrender.com/liff-checkin';

    async function startCheckIn() {
      await liff.init({ liffId: '2007367348-wz2VRNqM' });
      console.log('開始打卡流程');
      if (!liff.isLoggedIn()) {
        liff.login();
        return;
      }

      if (!liff.isInClient()){
        console.log('網頁在外部');
      }
      const profile = await liff.getProfile();
      const userId = profile.userId;
      const displayName = profile.displayName;
      console.log('取得 userId:', userId);
      console.log('取得 displayName:', displayName);
      console.log('白名單比對結果:', WHITELIST.includes(userId));
      if (!WHITELIST.includes(userId)) {
        alert('您不在打卡清單中');
        return;
      }
      navigator.geolocation.getCurrentPosition(function(position) {
        const payload = {
          userId,
          displayName,
          latitude: position.coords.latitude,
          longitude: position.coords.longitude,
          timestamp: new Date().toLocaleString('zh-TW', {timeZone: 'Asia/Taipei', hour12: false})
          //timestamp: new Date().toISOString()
        };
        console.log('取得 latitude:', payload.latitude);
        console.log('取得 longitude:', payload.longitude);
        console.log('取得 timestamp:', payload.timestamp);
        alert(JSON.stringify(payload));
        //fetch(GAS_WEBHOOK, {
        fetch(RENDER_WEBHOOK, {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'application/json' }
        //}).then(res => {
          //console.log('GAS 回應:', res);
          //return res.json();
          //}).then(data => {
          //   console.log('GAS 回傳資料:', data);
          //   alert('打卡成功！');
          //}).catch(err => {
           //  console.error('打卡失敗:', err);
           //  alert('打卡失敗，請稍後再試');
          });       
      });
      if (liff.isInClient()){
        alert('bye');
        liff.closeWindow();
      } 
    }
  </script>
</body>
</html>
